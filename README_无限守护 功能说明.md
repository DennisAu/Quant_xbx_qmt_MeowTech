# ∞MeowTech.实盘无限守护 - 功能说明文档

> **作者**: ∞MeowTech @萌新小强 @无限进化 @萌新小王 @大蒜
> **更新时间**: 2025年06月29日 14:35  
> **版本**: 3.0  
> **兼容性**: Windows 10/11, Python 3.8+, PySide6  

## 🚀 程序概述

∞MeowTech.实盘无限守护是一款专为量化交易设计的自动化管理工具，专注于QMT和彩虹客户端的智能化运维管理。
程序采用模块化架构设计，提供完整的进程管理、定时任务、网络监控和飞书通知等功能。

## 🌟 核心特性

### 1. 智能进程管理
- **QMT客户端管理**：自动重启、优雅关闭、进程健康监控
- **彩虹客户端管理**：定时重启、数据清理、状态监控
- **进程安全保护**：防止误杀、优雅关闭机制、僵尸进程检测
- **多实例检测**：自动识别并处理同一程序的多个实例

### 2. 行情源智能优选
- **自动服务器发现**：扫描QMT配置文件中的所有可用服务器
- **延迟测试**：并发测试多个服务器的网络延迟
- **智能选择**：基于统计学方法选择最佳行情和交易服务器
- **VIP服务器优先**：支持仅使用VIP服务器的配置选项
- **配置自动更新**：自动更新QMT配置文件中的服务器设置

### 3. 实时监控系统
- **网络状态监控**：实时检测网络连接状态
- **进程状态监控**：监控QMT和彩虹客户端运行状态
- **状态变化通知**：网络或进程状态变化时自动发送通知
- **可视化状态显示**：界面实时显示各项监控指标

### 4. 飞书通知集成
- **实时通知**：支持飞书Webhook通知
- **@所有人功能**：重要事件可@所有人
- **通知频率控制**：防止频繁发送相同通知
- **时间段控制**：可设置通知的有效时间段
- **自动测试**：配置保存时自动测试通知功能

### 5. 定时任务管理
- **灵活时间配置**：支持HH:MM:SS格式的精确时间设置
- **多任务支持**：同时管理重启和关闭任务
- **任务状态显示**：实时显示下次运行时间和任务列表
- **系统关机**：支持定时系统关机功能

### 6. 数据管理
- **早盘数据清理**：彩虹客户端重启前自动清理早盘数据
- **配置持久化**：配置自动保存到框架logs目录
- **日志记录**：详细的操作日志记录

### 7. 开机启动管理
- **注册表管理**：通过Windows注册表设置开机启动
- **权限检测**：自动检测管理员权限
- **状态诊断**：开机启动环境诊断功能
- **一键切换**：支持一键启用/禁用开机启动

## 📁 程序架构

```
Trd3_无限守护.py
├── 配置管理模块 (ConfigManager)
│   ├── 默认配置定义
│   ├── 配置文件读写 (logs/guardian_config.json)
│   └── 配置验证和更新
├── 工具函数模块
│   ├── 日志记录 (log) - UTF-8编码支持
│   ├── 时间验证 (is_valid_time)
│   ├── 内存管理 (MemoryManager)
│   └── 异步任务管理 (AsyncTaskManager)
├── 网络测试模块 (NetworkTester)
│   ├── 延迟测量
│   ├── 中位数计算
│   └── 并发测试支持
├── 飞书通知模块 (FeishuNotifier)
│   ├── Webhook消息发送
│   ├── @所有人支持
│   ├── 频率控制
│   └── 时间段控制
├── 行情源优选模块 (ServerOptimizer)
│   ├── 服务器发现和解析
│   ├── 并发延迟测试
│   ├── 最佳服务器选择
│   ├── VIP服务器过滤
│   └── 配置文件更新
├── 进程管理模块 (ProcessManager)
│   ├── 优雅关闭机制 (SIGTERM → SIGKILL)
│   ├── 僵尸进程检测和清理
│   ├── 进程健康状态监控
│   ├── 多实例检测
│   └── 启动确认机制
├── 实时监控模块 (MonitoringThread)
│   ├── QMT进程状态监控
│   ├── 网络状态监控
│   ├── 状态变化检测
│   └── 自动通知发送
├── 数据管理模块 (DataManager)
│   └── 早盘数据自动清理
├── 开机启动管理模块 (StartupManager)
│   ├── 注册表操作
│   ├── 权限检测
│   └── 环境诊断
├── 定时任务管理模块 (ScheduleManager)
│   ├── 任务调度引擎
│   ├── 多任务并发执行
│   └── 任务生命周期管理
├── 核心业务逻辑模块 (CoreLogic)
│   ├── 业务操作统一入口
│   ├── 模块间协调
│   └── 状态管理
└── 主窗口UI模块 (MainWindow)
    ├── 操作页面 (QMT控制、彩虹控制、系统控制)
    ├── 配置页面 (路径、时间、监控、通知配置)
    ├── 实时状态显示
    └── 线程安全的UI更新
```

## 🎯 主要功能详解

### 1. QMT管理功能

#### 自动重启流程
1. **进程检测**：检查当前QMT进程状态
2. **优雅关闭**：先发送SIGTERM信号，等待进程自然退出
3. **强制终止**：超时后使用SIGKILL强制终止
4. **行情源优选**：自动测试并选择最佳服务器
5. **重新启动**：启动QMT并确认启动成功
6. **状态监控**：持续监控新进程的健康状态

#### 行情源优选算法

# 服务器选择逻辑
1. 扫描QMT配置文件，提取所有服务器信息
2. 根据VIP设置过滤服务器列表
3. 并发测试所有服务器的网络延迟
4. 计算延迟中位数，选择最佳服务器
5. 更新QMT配置文件
6. 记录优选结果到日志


### 2. 彩虹客户端管理

#### 重启流程
1. **数据清理**：删除指定的早盘数据文件夹
2. **进程终止**：优雅关闭彩虹客户端进程
3. **重新启动**：启动彩虹客户端
4. **状态确认**：确认启动成功

#### 数据清理机制
- 支持配置多个文件夹名称（逗号分隔）
- 自动检测文件夹存在性
- 安全删除，避免误删重要数据

### 3. 实时监控系统

#### 监控指标
- **网络状态**：通过ping测试网络连通性
- **QMT进程状态**：检测QMT是否正常运行
- **服务器信息**：显示当前最佳行情和交易服务器
- **内存使用**：监控程序内存使用情况

#### 通知机制
- **状态变化通知**：网络或进程状态发生变化时发送通知
- **频率控制**：相同类型通知在指定时间内只发送一次
- **时间段控制**：只在指定时间段内发送通知
- **@所有人**：重要事件可@所有人

### 4. 定时任务系统

#### 支持的任务类型
- **QMT定时重启**：包含行情源优选
- **QMT定时关闭**：优雅关闭QMT
- **彩虹客户端定时重启**：包含数据清理
- **彩虹客户端定时关闭**：优雅关闭彩虹客户端
- **系统定时关机**：安全关闭系统
- **行情源优选**：独立的服务器优选任务

#### 时间配置格式
- **格式**：HH:MM:SS (24小时制)
- **示例**："08:50:00", "15:30:00"
- **留空**：留空表示不执行该任务

## 🔧 配置说明

### 配置文件位置
- **路径**：`<框架根目录>/logs/guardian_config.json`
- **格式**：JSON格式，UTF-8编码
- **自动创建**：首次保存配置时自动创建

### 主要配置项

#### QMT配置
```json
{
  "qmt_dir": "C:\\Program Files\\QMT\\bin.x64\\XtItClient.exe",
  "qmt_run_time": "08:50:00",
  "qmt_shutdown_time": "15:30:00",
  "qmt_only_vip": false
}
```

#### 彩虹客户端配置
```json
{
  "rainbow_exe_path": "C:\\彩虹客户端\\彩虹客户端.exe",
  "rainbow_restart_time": "08:45:00",
  "rainbow_shutdown_time": "15:35:00"
}
```

#### 数据清理配置
```json
{
  "delete_base_path": "C:\\彩虹客户端\\Data",
  "delete_folders": "早盘数据,临时文件"
}
```

#### 监控和通知配置
```json
{
  "monitor_interval": 10,
  "notification_interval": 300,
  "notification_start_time": "08:00:00",
  "notification_end_time": "16:00:00",
  "enable_feishu_notification": true,
  "feishu_webhook_url": "https://open.feishu.cn/open-apis/bot/v2/hook/xxx",
  "feishu_at_all": true
}
```

## 🛡️ 安全特性

### 1. 进程安全
- **精确匹配**：进程名和路径双重验证
- **优雅关闭**：三步式关闭流程保护数据
- **权限检查**：自动检测操作权限
- **僵尸进程防护**：主动检测和清理
- **多实例保护**：防止重复启动

### 2. 数据安全
- **配置验证**：输入格式和路径有效性检查
- **备份机制**：重要操作前自动备份
- **日志记录**：详细的操作审计日志
- **错误恢复**：配置加载失败时使用默认值

### 3. 系统安全
- **权限控制**：需要管理员权限运行
- **安全删除**：数据删除前进行确认
- **资源管理**：及时释放系统资源
- **异常处理**：完善的异常捕获和处理

### 4. 网络安全
- **超时控制**：网络操作设置合理超时
- **重试机制**：网络失败时自动重试
- **状态验证**：网络状态实时验证
- **安全通信**：使用HTTPS进行通知发送

## 📈 性能优化

### 1. 内存优化
- **智能缓存**：合理使用内存缓存减少重复计算
- **及时释放**：不用的对象及时释放
- **内存监控**：实时监控内存使用情况
- **垃圾回收**：主动触发垃圾回收

### 2. 响应优化
- **异步执行**：耗时操作在后台线程执行
- **非阻塞UI**：界面操作不阻塞主线程
- **实时反馈**：操作状态实时反馈
- **批量处理**：相似操作批量执行

### 3. 网络优化
- **并发测试**：多服务器并发延迟测试
- **智能选择**：基于统计学方法选择最佳服务器
- **连接复用**：复用网络连接减少开销
- **超时优化**：根据网络状况调整超时时间

### 4. 系统优化
- **进程管理**：优化进程启动和关闭流程
- **资源监控**：实时监控系统资源使用
- **任务调度**：智能的任务调度算法
- **状态缓存**：缓存系统状态减少查询

## 🎨 用户界面

### 操作页面
- **QMT控制组**：重启/关闭按钮、服务器信息显示
- **彩虹客户端控制组**：重启/关闭按钮
- **系统控制组**：开机启动设置、立即关机
- **定时任务总控组**：启动/停止定时器、下次运行时间
- **实时状态显示**：网络状态、QMT进程状态

### 配置页面
- **QMT配置组**：路径、时间、VIP服务器设置
- **彩虹客户端配置组**：路径、时间设置
- **数据删除配置组**：基础路径、文件夹名称
- **系统监控配置组**：监控间隔、通知设置、飞书配置
- **保存配置按钮**：一键保存所有配置

### 界面特色
- **现代化设计**：基于PySide6的现代化界面
- **状态指示**：颜色编码的状态指示
- **实时更新**：状态信息实时更新
- **操作反馈**：操作结果即时反馈
- **中文界面**：完全中文化的用户界面

## 🔄 使用流程

### 首次使用
1. **安装依赖**：`pip install -r requirements.txt`
2. **以管理员身份运行程序**
3. **配置路径**：在配置页面设置QMT和彩虹客户端路径
4. **配置时间**：设置各项定时任务时间
5. **配置通知**：设置飞书Webhook（可选）
6. **保存配置**：点击保存配置按钮
7. **启动定时任务**：在操作页面启动定时任务

### 日常使用
1. **查看状态**：在操作页面查看各项状态
2. **手动操作**：需要时手动重启或关闭程序
3. **监控运行**：观察定时任务执行情况
4. **调整配置**：根据需要调整配置参数

### 故障处理
1. **查看日志**：检查控制台输出的日志信息
2. **检查配置**：确认配置参数正确
3. **检查权限**：确保有管理员权限
4. **重启程序**：必要时重启程序

## 📝 版本历史

### v3.0 (2025-06-29)
- 🆕 新增飞书通知集成
- 🆕 新增实时监控系统
- 🆕 新增内存管理机制
- 🆕 新增异步任务管理
- 🔧 优化行情源优选算法
- 🔧 改进进程管理机制
- 🔧 增强配置管理功能
- 🎨 优化用户界面设计
- 🐛 修复多项已知问题

### v2.0 (2025-06-24)
- 🆕 模块化架构重构
- 🆕 新增进程健康监控
- 🆕 新增开机启动管理
- 🔧 优化定时任务系统
- 🔧 改进错误处理机制

### v1.0 (2025-06-13)
- 🆕 基础功能实现
- 🆕 QMT和彩虹客户端管理
- 🆕 定时任务功能
- 🆕 行情源优选功能

---

**技术支持**: ∞MeowTech  
**更新日期**: 2025年06月29日  
**文档版本**: 3.0