# 进程管理技术文档

## 概述

本文档详细说明了实盘无限守护程序中进程管理模块（ProcessManager）的技术实现和使用方法。该模块提供了增强的进程管理功能，包括优雅关闭、状态监控、健康检查等特性。

## 核心特性

### 1. 优雅关闭机制

进程关闭采用三步式流程，最大程度保护数据安全：

```
步骤1: 发送SIGTERM信号 → 等待进程自然退出
步骤2: 超时检查 → 如果进程仍在运行
步骤3: 发送SIGKILL信号 → 强制终止进程
```

**技术实现**：
- 使用 `psutil.Process.terminate()` 发送SIGTERM信号
- 使用 `psutil.Process.wait(timeout)` 等待进程退出
- 超时后使用 `psutil.Process.kill()` 强制终止
- 默认优雅关闭超时时间：10秒

### 2. 僵尸进程检测

自动检测和报告僵尸进程，防止系统资源泄漏：

**检测机制**：
- 遍历系统所有进程
- 检查进程状态是否为 `psutil.STATUS_ZOMBIE`
- 尝试获取僵尸进程的父进程信息
- 提供清理建议

**清理策略**：
- 僵尸进程无法直接终止
- 需要父进程调用wait()系统调用
- 建议重启系统彻底清理

### 3. 进程状态监控

实时获取进程的详细状态信息：

**监控指标**：
- 进程ID (PID)
- 进程状态 (running, sleeping, zombie等)
- 可执行文件路径
- 运行时间
- 内存使用量 (MB)
- CPU使用率 (%)

**性能优化**：
- 使用 `psutil.process_iter()` 批量获取进程信息
- 只获取必要的进程属性，减少系统调用
- 异常处理避免进程消失导致的错误

### 4. 健康检查功能

全面的进程健康状态评估：

**检查项目**：
- 进程是否正在运行
- 是否存在多实例运行
- 是否存在僵尸进程
- 内存使用是否异常（>1GB触发警告）

**返回格式**：
```python
{
    'process_name': '进程名称',
    'is_healthy': True/False,
    'issues': ['问题列表'],
    'recommendations': ['建议列表'],
    'status': '详细状态信息'
}
```

## API 参考

### ProcessManager.terminate_processes_by_name()

**功能**：根据进程名终止进程（增强版优雅关闭）

**参数**：
- `process_name` (str): 进程名称
- `target_path` (str, 可选): 目标路径过滤
- `graceful_timeout` (int, 默认10): 优雅关闭超时时间（秒）

**返回值**：
- `tuple`: (成功终止的进程数, 失败的进程数)

**使用示例**：
```python
success_count, failed_count = ProcessManager.terminate_processes_by_name(
    'XtMiniQmt.exe', 
    graceful_timeout=15
)
print(f"成功终止 {success_count} 个进程，失败 {failed_count} 个")
```

### ProcessManager.start_process()

**功能**：启动进程（增强版启动机制）

**参数**：
- `exe_path` (str): 可执行文件路径
- `wait_for_start` (bool, 默认True): 是否等待进程启动确认
- `start_timeout` (int, 默认30): 启动超时时间（秒）

**返回值**：
- `tuple`: (是否成功, 进程PID或错误信息)

**使用示例**：
```python
success, result = ProcessManager.start_process(
    'C:\\Program Files\\QMT\\bin.x64\\XtItClient.exe',
    wait_for_start=True,
    start_timeout=30
)
if success:
    print(f"进程启动成功，PID: {result}")
else:
    print(f"进程启动失败: {result}")
```

### ProcessManager.get_process_status()

**功能**：获取进程状态信息

**参数**：
- `process_name` (str): 进程名称
- `target_path` (str, 可选): 目标路径过滤

**返回值**：
- `dict`: 进程状态信息字典

**使用示例**：
```python
status = ProcessManager.get_process_status('XtMiniQmt.exe')
print(f"进程数量: {status['count']}")
print(f"是否运行: {status['is_running']}")
for proc in status['processes']:
    print(f"PID: {proc['pid']}, 内存: {proc['memory_mb']:.1f}MB")
```

### ProcessManager.monitor_process_health()

**功能**：监控进程健康状态

**参数**：
- `process_name` (str): 进程名称
- `target_path` (str, 可选): 目标路径过滤

**返回值**：
- `dict`: 健康状态报告

**使用示例**：
```python
health = ProcessManager.monitor_process_health('XtMiniQmt.exe')
if not health['is_healthy']:
    print("发现问题:")
    for issue in health['issues']:
        print(f"  - {issue}")
    print("建议:")
    for rec in health['recommendations']:
        print(f"  - {rec}")
```

## 错误处理

### 常见异常类型

1. **psutil.NoSuchProcess**
   - 原因：进程在操作过程中消失
   - 处理：忽略该异常，继续处理其他进程

2. **psutil.AccessDenied**
   - 原因：权限不足，无法访问进程
   - 处理：记录错误日志，提示用户检查权限

3. **psutil.TimeoutExpired**
   - 原因：进程在指定时间内未响应
   - 处理：转入强制终止流程

4. **FileNotFoundError**
   - 原因：可执行文件不存在
   - 处理：返回错误信息，提示用户检查路径

### 错误处理策略

```python
try:
    # 进程操作
    pass
except psutil.NoSuchProcess:
    # 进程已消失，正常情况
    log("进程已自然退出")
except psutil.AccessDenied:
    # 权限不足
    log("权限不足，无法操作进程")
except Exception as e:
    # 其他异常
    log(f"操作失败: {str(e)}")
```

## 性能优化

### 1. 批量操作
- 使用 `psutil.process_iter()` 一次性获取所有进程信息
- 避免多次系统调用的开销

### 2. 属性过滤
- 只获取必要的进程属性
- 减少内存使用和处理时间

### 3. 异常处理
- 预期异常的快速处理
- 避免异常传播影响整体性能

### 4. 资源管理
- 及时释放进程句柄
- 避免资源泄漏

## 安全考虑

### 1. 权限验证
- 检查当前用户是否有足够权限操作目标进程
- 提供明确的权限不足提示

### 2. 路径验证
- 验证可执行文件路径的有效性
- 防止路径注入攻击

### 3. 进程识别
- 使用进程名和路径双重验证
- 避免误操作无关进程

### 4. 优雅关闭
- 优先使用SIGTERM信号
- 给进程充分时间保存数据

## 最佳实践

### 1. 超时设置
- 根据应用类型调整优雅关闭超时时间
- 数据库应用建议30秒以上
- 简单应用可设置5-10秒

### 2. 错误处理
- 始终检查返回值
- 记录详细的错误日志
- 提供用户友好的错误提示

### 3. 状态监控
- 定期检查进程健康状态
- 设置内存使用阈值警告
- 监控僵尸进程的产生

### 4. 资源管理
- 及时清理不需要的进程句柄
- 避免长时间持有进程对象
- 使用上下文管理器确保资源释放

## 版本历史

### v2.0 (当前版本)
- 新增优雅关闭机制
- 新增僵尸进程检测
- 新增进程状态监控
- 新增健康检查功能
- 改进错误处理和日志记录

### v1.0 (原始版本)
- 基础的进程启动和终止功能
- 简单的错误处理

## 技术支持

如果在使用过程中遇到问题，请：

1. 查看控制台日志输出
2. 检查系统权限设置
3. 确认进程路径配置
4. 参考故障排除指南

---

**作者**:  ∞MeowTech @萌新小强 @无限进化 @萌新小王 @大蒜
**版本**: 2.0  
**更新日期**: 2025年  
**兼容性**: Windows 10/11, Python 3.8+